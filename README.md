
# æ— é”æ•°æ®ç»“æ„å¹¶å‘ä¸å†…å­˜æµ‹è¯•æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä½¿ç”¨é›†æˆåœ¨ CMake ä¸­çš„ **Sanitizers (TSan/ASan)** å·¥å…·æ¥æ£€æµ‹æ— é”æ•°æ®ç»“æ„ä¸­çš„ç«æ€æ¡ä»¶ï¼ˆData Raceï¼‰å’Œå†…å­˜é—®é¢˜ï¼ˆUse-After-Free / Memory Leakï¼‰ã€‚

ç”±äºæ— é”ç¼–ç¨‹ï¼ˆLock-freeï¼‰å¯¹å†…å­˜åºæä¸ºæ•æ„Ÿï¼Œå»ºè®®åœ¨æ¯æ¬¡ä¿®æ”¹æ ¸å¿ƒé€»è¾‘åï¼Œéƒ½æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œä¸¥æ ¼æµ‹è¯•ã€‚

## ğŸ›  å‰ç½®è¯´æ˜ï¼šWSL/Linux ç¯å¢ƒç‰¹æ®Šå¤„ç†

åœ¨ WSL2 æˆ–éƒ¨åˆ† Linux å†…æ ¸ä¸Šï¼ŒTSan å¯èƒ½ä¼šå› ä¸º ASLRï¼ˆåœ°å€ç©ºé—´éšæœºåŒ–ï¼‰å¯¼è‡´å†…å­˜æ˜ å°„å†²çªå´©æºƒã€‚
**å¿…é¡»ä½¿ç”¨ `setarch x86_64 -R` å‘½ä»¤æ¥è¿è¡Œç¼–è¯‘å’Œæµ‹è¯•ã€‚**

å¦‚æœå‡ºç° `Clock skew detected` è­¦å‘Šï¼Œè¯·å…ˆæ‰§è¡Œï¼š
```bash
find . -type f -exec touch {} +
```

---

## ğŸš€ æ¨¡å¼ä¸€ï¼šThreadSanitizer (TSan) - æ£€æµ‹æ•°æ®ç«äº‰

è¿™æ˜¯**æœ€é‡è¦**çš„æµ‹è¯•æ¨¡å¼ã€‚å®ƒèƒ½æ•è·å¤šçº¿ç¨‹åŒæ—¶è¯»å†™åŒä¸€å†…å­˜ä¸”æœªåŠ é”ï¼ˆæˆ–åŸå­åºé”™è¯¯ï¼‰çš„æƒ…å†µã€‚

### 1. ç¼–è¯‘
```bash
mkdir -p build && cd build
rm -rf *  # å¿…é¡»æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶

# å¼€å¯ TSan å¼€å…³
cmake -DENABLE_TSAN=ON ..

# ä½¿ç”¨ setarch ç¦ç”¨åœ°å€éšæœºåŒ–è¿›è¡Œç¼–è¯‘
setarch x86_64 -R make -j4
```

### 2. è¿è¡Œå•æ¬¡æµ‹è¯•
```bash
setarch x86_64 -R ctest --verbose
```
*   **é€šè¿‡æ ‡å‡†ï¼š** æ²¡æœ‰ä»»ä½•è¾“å‡ºåŒ…å« `WARNING: ThreadSanitizer: data race`ã€‚
*   **å¤±è´¥è¡¨ç°ï¼š** ç¨‹åºå´©æºƒï¼Œæˆ–æ‰“å°å‡ºè¯¦ç»†çš„ä¸¤ä¸ªçº¿ç¨‹è®¿é—®åŒä¸€åœ°å€çš„å †æ ˆä¿¡æ¯ã€‚

---

## ğŸ” æ¨¡å¼äºŒï¼šAddressSanitizer (ASan) - æ£€æµ‹å†…å­˜è¯¯ç”¨

æ­¤æ¨¡å¼ç”¨äºæ£€æµ‹ **Use-After-Free**ï¼ˆèŠ‚ç‚¹è¢«åˆ åè¿˜åœ¨è¯»ï¼Œå¸¸è§äº ABA é—®é¢˜ï¼‰ã€å †æ ˆæº¢å‡ºå’Œå†…å­˜æ³„æ¼ã€‚

### 1. ç¼–è¯‘
**æ³¨æ„ï¼šå¿…é¡»å…ˆæ¸…ç†æ‰ TSan çš„æ„å»ºæ–‡ä»¶ï¼Œä¸¤è€…ä¸èƒ½å…±å­˜ã€‚**

```bash
cd build
rm -rf * 

# å¼€å¯ ASan å¼€å…³
cmake -DENABLE_ASAN=ON ..

make -j4
```

### 2. è¿è¡Œå•æ¬¡æµ‹è¯•
```bash
ctest --verbose
```
*   **å¤±è´¥è¡¨ç°ï¼š** å‡ºç°çº¢è‰²æŠ¥é”™ `ERROR: AddressSanitizer: heap-use-after-free` æˆ– `memory-leak`ã€‚

---

## âš¡ æ¨¡å¼ä¸‰ï¼šæš´åŠ›å‹åŠ›æµ‹è¯• (Stress Test)

æœ‰äº›å¹¶å‘ Bug éœ€è¦ç‰¹å®šçš„æ—¶é—´çª—å£ï¼ˆTiming Windowï¼‰æ‰ä¼šè§¦å‘ã€‚å•æ¬¡è¿è¡Œ `ctest` å¾€å¾€ä¸å¤Ÿï¼Œéœ€è¦æ­»å¾ªç¯è·‘å‡ åƒæ¬¡ã€‚

è¯·åœ¨ `build` ç›®å½•ä¸‹åˆ›å»ºè„šæœ¬ `stress.sh`ï¼š

```bash
#!/bin/bash
# ç”¨æ³•: ./stress.sh

echo "ğŸ”¥ å¼€å§‹å‹åŠ›æµ‹è¯• (æŒ‰ Ctrl+C åœæ­¢)..."
COUNT=0

# å»ºè®®åœ¨ TSan æ¨¡å¼ä¸‹è¿è¡Œæ­¤è„šæœ¬
# å¦‚æœæ˜¯ WSL ç¯å¢ƒï¼ŒåŠ ä¸Š setarch x86_64 -R
CMD="setarch x86_64 -R ./tests/run_tests"

while true; do
    COUNT=$((COUNT+1))
    
    # ä»…è¿‡æ»¤å¹¶å‘ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´
    # ä¹Ÿå¯ä»¥å»æ‰ --gtest_filter è·‘å…¨é‡
    $CMD --gtest_filter=*Concurrent* > /dev/null 2>&1
    
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -ne 0 ]; then
        echo "âŒ åœ¨ç¬¬ $COUNT æ¬¡è¿è¡Œæ—¶å‘ç°äº† Bugï¼"
        echo "æ­£åœ¨é‡ç°å¹¶æ‰“å°æ—¥å¿—..."
        $CMD --gtest_filter=*Concurrent*
        break
    fi
    
    if (( $COUNT % 100 == 0 )); then
        echo "âœ… å·²é€šè¿‡ $COUNT æ¬¡æµ‹è¯•..."
    fi
done
```

**å»ºè®®æµç¨‹ï¼š**
1. ç¼–è¯‘ TSan ç‰ˆæœ¬ -> è¿è¡Œ `stress.sh` è‡³å°‘ 10 åˆ†é’Ÿã€‚
2. ç¼–è¯‘ ASan ç‰ˆæœ¬ -> è¿è¡Œ `stress.sh` è‡³å°‘ 10 åˆ†é’Ÿã€‚

---

## â“ å¸¸è§é—®é¢˜æ’æŸ¥

**Q: æŠ¥é”™ `FATAL: ThreadSanitizer: unexpected memory mapping`**
**A:** ä½ å¿˜è®°åŠ  `setarch x86_64 -R` äº†ã€‚è¯·å‚è€ƒâ€œå‰ç½®è¯´æ˜â€ã€‚

**Q: æŠ¥é”™ `undefined reference to __tsan_init`**
**A:** é“¾æ¥é€‰é¡¹ä¸¢å¤±ã€‚è¯·ç¡®è®¤ `CMakeLists.txt` ä¸­æ˜¯å¦æ·»åŠ äº† `add_link_options(-fsanitize=thread ...)` ä¸”æ‰§è¡Œäº† `rm -rf *` æ¸…ç†ç¼“å­˜ã€‚

**Q: æµ‹è¯•è¿è¡Œææ…¢**
**A:** æ­£å¸¸ç°è±¡ã€‚TSan ä¼šä½¿ç¨‹åºå˜æ…¢ 5-10 å€ï¼ŒASan å˜æ…¢ 2 å€å·¦å³ã€‚è¿™æ˜¯ä¸ºäº†æ•è· Bug å¿…é¡»ä»˜å‡ºçš„ä»£ä»·ã€‚